// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Company {
  id             String          @id @default(uuid())
  name           String          @unique
  logoUrl        String?         // 公司logo图片URL
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  reimbursements Reimbursement[]

  @@map("companies")
}

model Reimbursement {
  id          String    @id @default(uuid())
  title       String
  description String?
  status      String    @default("待整理") // 待整理, 待打印单据, 待审批, 待打款, 已完成
  totalAmount Float     @default(0)
  startDate   DateTime? // 开始日期
  endDate     DateTime? // 结束日期
  companyId   String?   // 所属公司
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  items   ExpenseItem[]
  company Company?      @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@map("reimbursements")
  @@index([companyId])
}

model ExpenseItem {
  id              String        @id @default(uuid())
  reimbursementId String
  amount          Float         // 用户定义的费用金额
  date            DateTime
  description     String?
  category        String        // 交通, 餐饮, 住宿, 办公, 其他
  hasInvoice      Boolean       @default(false) // 是否已开票
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  reimbursement   Reimbursement @relation(fields: [reimbursementId], references: [id], onDelete: Cascade)
  invoices        Invoice[]     // 一对多关系
  invoiceBoxes    InvoiceBox[]  // 反向关联：关联的发票箱发票

  @@map("expense_items")
  @@index([reimbursementId])
}

model Invoice {
  id              String      @id @default(uuid())
  expenseItemId   String
  invoiceBoxId    String?     // 关联的发票箱ID（如果来自发票箱）
  fileName        String
  filePath        String
  amount          Float       // 发票金额
  date            DateTime    // 发票日期
  description     String?     // 发票描述（从OCR识别）
  uploadedAt      DateTime    @default(now())
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  expenseItem     ExpenseItem @relation(fields: [expenseItemId], references: [id], onDelete: Cascade)

  @@map("invoices")
  @@index([expenseItemId])
  @@index([invoiceBoxId])
}

model InvoiceBox {
  id              String       @id @default(uuid())
  invoiceNumber   String       @unique // 发票号码
  invoiceType     String       // 开票类型（增值税专用发票、增值税普通发票、电子发票等）
  totalAmount     Float        // 票面总额
  taxRate         Float?       // 税率（百分比，如13表示13%）
  taxAmount       Float?       // 票面税额
  invoiceDate     DateTime     // 开票日期
  buyerName       String?      // 购买方名称
  remark          String?      // 备注信息（如火车票的行程信息）
  tags            String?      // 标签（逗号分隔）
  fileName        String       // 附件文件名
  filePath        String       // 附件路径
  status          String       @default("未使用") // 状态：未使用、已使用
  usedInItemId    String?      // 如果已使用，关联的费用项目ID
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  expenseItem     ExpenseItem? @relation(fields: [usedInItemId], references: [id], onDelete: SetNull)

  @@map("invoice_box")
  @@index([status])
  @@index([invoiceDate])
  @@index([usedInItemId])
}
